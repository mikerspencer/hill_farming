---
title: "Census employment data QA"
author: "Mike Spencer"
date: "3 July 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, message=F)
library(rgdal)
library(broom)
library(tidyverse)
library(viridis)
library(knitr)
options(scipen = 999)
```


## Introduction

### Purpose

This document is part of a project evaluating the importance of hill farming in Scottish communities. It compares census data at output area level (as downloaded), to aggregations at agricultural parish level.


```{r agricultural_parishes, fig.cap="2016 agricultural parishes"}
parishes = readOGR(paste0(normalizePath("~"), "/Cloud/Michael/SRUC/hill_farms/data/spatial/ag_parishes_2016.gpkg"), "simplified_parishes")

Scotland = readOGR(paste0(normalizePath("~"), "/Cloud/Michael/SRUC/hill_farms/data/spatial/ag_parishes_2016.gpkg"), "Scotland") %>% 
   tidy()

parishes$id = row.names(parishes)
parishes = tidy(parishes) %>% 
   left_join(parishes@data)
```

```{r data load}
census = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/census/pop_census.csv") %>% 
   mutate_all(funs(replace(., is.na(.), 0)))

parishes = parishes %>% 
   left_join(census, by=c("PARCode"="PARCode", "PARName"="PARName")) %>% 
   mutate_all(funs(replace(., is.na(.), 0)))
```


```{r functions}
plot.map = function(i, tit){
   ggplot(parishes, aes(long, lat, group=group)) +
      geom_polygon(aes_string(fill=i)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1) +
      labs(fill=tit) +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())
}

prop.map = function(i, j, tit){
   parishes %>% 
      rename_(x=i, y=j) %>% 
      mutate(plot_col=x / y) %>% 
   ggplot(aes(long, lat, group=group)) +
      geom_polygon(aes(fill=plot_col)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1) +
      labs(fill=tit) +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())
}

panel.cor = function(x, y, digits = 2, prefix = "", cex.cor, ...){
    usr = par("usr"); on.exit(par(usr))
    par(usr=c(0, 1, 0, 1))
    r = cor(x, y)
    txt = format(c(r, 0.123456789), digits = digits)[1]
    txt = paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor = 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}
```

## Absolute values for agricultural parishes

```{r pop totals}
plot.map("pop_all_2011", "2011\npopulation")

plot.map("pop_working_all_2011", "2011 working\npopulation")

plot.map("pop_working_land_2011", "2011 working in\nprimary production\npopulation")
```

Note that these results may be skewed by an issue with island polygons.

## Proportions for agricultural parishes

Proportions should correct nearly all potential issues with island polygons (until I fix the underlying cause), because populations are elevated for all areas. So taking relative values (proportions) 

```{r pop proportions}
prop.map("pop_working_land_2011", "pop_all_2011", "Proportion of\ntotal population\nemployed in\nprimary production")

prop.map("pop_working_land_2011", "pop_working_all_2011", "Proportion of\nworking population\nemployed in\nprimary production")
```

## Checks

### Aggregated to agricultural parishes

* Total people in 2011 = `r round(sum(census$pop_all_2011))`
* Total working population in 2011 = `r round(sum(census$pop_working_all_2011))`
* Ag/for/fish working population in 2011 = `r round(sum(census$pop_working_land_2011))`
* Proportion in land/primary of total population in 2011 = `r scales::percent(sum(census$pop_working_land_2011) / sum(census$pop_all_2011))`
* Proportion in land/primary of working population in 2011 = `r scales::percent(sum(census$pop_working_land_2011) / sum(census$pop_working_all_2011))`

### Using census output areas

These values are the benchmark, as they are unaltered from the downloaded versions.

```{r census OAs}
census_OA = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/census/census2011.csv") %>%
   filter(census_id!="Scotland")

census_spatial = readOGR(paste0(normalizePath("~"), "/Cloud/Michael/SRUC/hill_farms/data/spatial/", "OutputArea2011_MHW.shp"))
   
census_spatial$id = row.names(census_spatial)
census_spatial = tidy(census_spatial) %>% 
   left_join(census_spatial@data) %>% 
   select(long, lat, order, hole, piece, group, OBJECTID, code) %>% 
   left_join(census_OA, by=c("code"="census_id"))
```

* Total people in 2011 = `r sum(census_OA$pop_all_2011)`
* Total working population in 2011 = `r sum(census_OA$pop_working_all_2011)`
* Ag/for/fish working population in 2011 = `r sum(census_OA$pop_working_land_2011)`
* Proportion in land/primary of total population in 2011 = `r scales::percent(sum(census_OA$pop_working_land_2011) / sum(census_OA$pop_all_2011))`
* Proportion in land/primary of working population in 2011 = `r scales::percent(sum(census_OA$pop_working_land_2011) / sum(census_OA$pop_working_all_2011))`

Aggregation is causing inflation in certain areas. Likely due to rounding error, where proportions of a person are increased to the nearest whole number. These errors are very small across the whole of Scotland, but may have impact in isolated parishes.

### Differences between ag parishes and census OA

Using the census data as a benchmark, census data have been subtracted from aggregated data. Hence negative values mean aggregated data are less than the census output area data.

* Total people in 2011 = `r round(sum(census$pop_all_2011) - sum(census_OA$pop_all_2011))`
* Total working population in 2011 = `r round(sum(census$pop_working_all_2011) - sum(census_OA$pop_working_all_2011))`
* Ag/for/fish working population in 2011 = `r round(sum(census$pop_working_land_2011) - sum(census_OA$pop_working_land_2011))`

## Maps of census output areas

```{r census map}
ggplot(census_spatial, aes(long, lat, group=group)) +
      geom_polygon(aes(fill=pop_working_land_2011)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1) +
      labs(fill="Population\nworking on\nthe land (2011)") +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())

ggplot(census_spatial, aes(long, lat, group=group)) +
      geom_polygon(aes(fill=pop_working_land_2011/pop_all_2011)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1) +
      labs(fill="Proportion of\npopulation\nin primary\nproduction (2011)") +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())

ggplot(census_spatial, aes(long, lat, group=group)) +
      geom_polygon(aes(fill=pop_working_land_2011/pop_working_all_2011)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1) +
      labs(fill="Proportion of\nworking population\nin primary\nproduction (2011)") +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())
```


## Compared to historic parishes

Used here are employment figures.

```{r parish data}
civ_parish_2011 = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/census/civil_parish/KS605SC.csv", skip=4, na="-") %>% 
   rename(parish=X1,
          all=`All people aged 16 to 74 in employment`,                             
          A_agri=`A. Agriculture, forestry and fishing`,
          B_mining=`B. Mining and quarrying`,
          C_manufacture=`C. Manufacturing`,
          D_utility=`D. Electricity, gas, steam and air conditioning supply`,
          E_water=`E. Water supply, sewerage, waste management and remediation activities`,
          F_construction=`F. Construction`,
          G_retail=`G. Wholesale and retail trade, repair of motor vehicles and motorcycles`,
          H_transport=`H. Transport and storage`,
          I_accommo=`I. Accommodation and food service activities`,
          J_IT=`J. Information and communication`,
          K_finance=`K. Financial and insurance activities`,
          L_estate=`L. Real estate activities`,
          M_science=`M. Professional, scientific and technical activities`,
          N_admin=`N. Administrative and support service activities`,
          O_public=`O. Public administration and defence, compulsory social security`,
          P_edu=`P. Education`,
          Q_health=`Q. Human health and social work activities`,
          other=`R, S, T, U. Other`) %>% 
   mutate_all(funs(replace(., is.na(.), 0))) %>% 
   mutate(A_agri=100*A_agri/all,
          B_mining=100*B_mining/all,
          C_manufacture=100*C_manufacture/all,
          D_utility=100*D_utility/all,
          E_water=100*E_water/all,
          F_construction=100*F_construction/all,
          G_retail=100*G_retail/all,
          H_transport=100*H_transport/all,
          I_accommo=100*I_accommo/all,
          J_IT=100*J_IT/all,
          K_finance=100*K_finance/all,
          L_estate=100*L_estate/all,
          M_science=100*M_science/all,
          N_admin=100*N_admin/all,
          O_public=100*O_public/all) %>% 
   filter(parish!="Scotland")

civ_parish_2001 = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/census/civil_parish/KS11a.csv", skip=5, na="-") %>% 
   transmute(parish=X1,
          all=`All people aged 16 to 74 in employment`,                             
          A_agri=`Percentage of people aged 16 to 74 working in: Agriculture, hunting and forestry` + `Percentage of people aged 16 to 74 working in: Fishing`,
          B_mining=`Percentage of people aged 16 to 74 working in: Mining and quarrying`,
          C_manufacture=`Percentage of people aged 16 to 74 working in: Manufacturing`,
          D_utility=`Percentage of people aged 16 to 74 working in: Electricity, gas and water supply`,
          F_constr=`Percentage of people aged 16 to 74 working in: Construction`,
          G_retail=`Percentage of people aged 16 to 74 working in: Wholesale and retail trade, repairs`,
          H_transport=`Percentage of people aged 16 to 74 working in: Transport, storage and communications`,
          I_accommo=`Percentage of people aged 16 to 74 working in: Hotels and restaurants`,
          K_finance=`Percentage of people aged 16 to 74 working as: Financial intermediaries`,
          L_estate=`Percentage of people aged 16 to 74 working in: Real estate, renting and business activities`,
          O_public=`Percentage of people aged 16 to 74 working in: Public administration and defence, social security`,
          P_edu=`Percentage of people aged 16 to 74 working in: Education`,
          Q_health=`Percentage of people aged 16 to 74 working in: Health and social work`,
          other=`Percentage of people aged 16 to 74 working in: Other`) %>% 
   mutate_all(funs(replace(., is.na(.), 0))) %>% 
   filter(parish!="Scotland")
```

```{r ag2civ parishes}

```

```{r civ parish change}
x = civ_parish_2001 %>% 
   select(parish, all) %>% 
   inner_join(select(civ_parish_2011, parish, all), by=c("parish"="parish")) %>% 
   mutate(diff=100*all.x/all.y)

ggplot(x, aes(diff)) +
   geom_histogram()


civ_parish_2001 %>% 
   select(parish, A_agri) %>% 
   inner_join(select(civ_parish_2011, parish, A_agri), by=c("parish"="parish")) %>% 
   mutate(diff=A_agri.y-A_agri.x) %>% 
   ggplot(aes(diff)) +
   geom_histogram()
```

