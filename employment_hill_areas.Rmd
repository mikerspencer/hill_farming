---
title: "Census employment data QA"
author: "Mike Spencer"
date: "3 July 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, message=F)
library(rgdal)
library(broom)
library(tidyverse)
library(ggmap)
library(viridis)
library(knitr)
```


```{r functions}
plot.map = function(dat, i, tit){
   ggplot(dat, aes(long, lat, group=group)) +
      geom_polygon(aes_string(fill=i)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1,
                           breaks=pretty_breaks(n=5)) +
      labs(fill=tit) +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())
}
```

## Introduction

### Purpose

This document is part of a project evaluating the importance of hill farming in Scottish communities. It compares agricultural and population census data at an agricultural parish level to an index of hill farming.


```{r data}
parishes = readOGR(paste0(normalizePath("~"), "/Cloud/Michael/SRUC/hill_farms/data/spatial/ag_parishes_2016.gpkg"), "simplified_parishes")

parishes$id = row.names(parishes)
parishes = tidy(parishes) %>% 
   left_join(parishes@data)

Scotland = readOGR(paste0(normalizePath("~"), "/Cloud/Michael/SRUC/hill_farms/data/spatial/ag_parishes_2016.gpkg"), "Scotland") %>% 
   tidy()

hills = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/hilliness.csv")
ag_census_2000 = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/census/ag_census_2000.csv")
ag_census_2011 = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/census/ag_census_2011.csv")
census = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/census/pop_census.csv")
designations = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/designations.csv")

# parishes = parishes %>% 
#    left_join(census, by=c("PARCode"="PARCode", "PARName"="PARName")) %>% 
#    mutate_all(funs(replace(., is.na(.), 0)))
```

## Population census

Population census data missing for some areas in 2001.
Missing for some variables, but not others.


```{r population census}
hills %>% 
   left_join(census) %>% 
   ggplot(aes(score, pop_all_2001)) +
   geom_point()

hills %>% 
   left_join(census) %>% 
   mutate(perc_diff = (pop_all_2011 - pop_all_2001) / pop_all_2001) %>% 
   ggplot(aes(score, perc_diff)) +
   geom_point(alpha=0.25) +
   scale_y_continuous(labels=scales::percent) +
   labs(x="Hill score",
        y="Percentage change between 2001 and 2011")

x = hills %>% 
   left_join(census) %>% 
   mutate(perc_diff = (pop_all_2011 - pop_all_2001) / pop_all_2001) %>% 
   select(PARCode, perc_diff)

parishes %>% 
   left_join(x) %>% 
   plot.map("perc_diff", "Population change")

```


## Comparisons

* Urban/rural classification: <http://www.gov.scot/Publications/2018/03/6040/downloads>
* SNH Wild land: <https://gateway.snh.gov.uk/natural-spaces/>
* SNH National Nature Reserves (NNR): <https://gateway.snh.gov.uk/natural-spaces/>
* JHI Land capability for forestry: <http://www.hutton.ac.uk/learning/natural-resource-datasets>

```{r functions}
plot.map = function(i, tit){
   ggplot(parishes, aes(long, lat, group=group)) +
      geom_polygon(aes_string(fill=i)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1) +
      labs(fill=tit) +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())
}

prop.map = function(i, j, tit){
   parishes %>% 
      rename_(x=i, y=j) %>% 
      mutate(plot_col=x / y) %>% 
   ggplot(aes(long, lat, group=group)) +
      geom_polygon(aes(fill=plot_col)) +
      geom_polygon(data=Scotland, aes(long, lat, group=group),
                   colour="grey30", fill=NA, size=0.1) +
      coord_equal() +
      scale_fill_distiller(palette="Greens", direction=1) +
      labs(fill=tit) +
      theme_minimal() +
      theme(axis.text=element_blank(),
            axis.title=element_blank(),
            line=element_blank())
}

panel.cor = function(x, y, digits = 2, prefix = "", cex.cor, ...){
    usr = par("usr"); on.exit(par(usr))
    par(usr=c(0, 1, 0, 1))
    r = cor(x, y)
    txt = format(c(r, 0.123456789), digits = digits)[1]
    txt = paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor = 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}
```

