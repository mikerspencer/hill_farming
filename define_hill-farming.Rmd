---
title: "Defining hill farming"
author: "Mike Spencer"
date: "16 April 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, message=F)
library(rgdal)
library(broom)
library(tidyverse)
library(viridis)
library(knitr)
```

## Introduction

### Purpose

### Output level

Will be agricultural parishes.
2016 data, downloaded from: <https://data.gov.uk/dataset/939fdd5e-7322-4ab7-9dc9-bbfc538c4477/agricultural-parishes>.


```{r agricultural_parishes, fig.cap="2016 agricultural parishes"}
parishes = readOGR(paste0(normalizePath("~"), "/Cloud/Michael/SRUC/hill_farms/data/spatial/ag_parishes_2016.gpkg"), "simplified_parishes")

parishes$id = row.names(parishes)
parishes = tidy(parishes) %>% 
   left_join(parishes@data)

ggplot(parishes, aes(long, lat, group=group)) +
   geom_polygon(colour="grey30", fill="grey90", size=0.1) +
   coord_equal() +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

There are `r length(unique(parishes$PARCode))` agricultural parishes in Scotland.
Why report at ag parish level?

## Defining hill farming

Data were collected from a variety of sources:

* Urban/rural: <http://www.gov.scot/Publications/2018/03/6040/downloads>
* Elevation: <https://www.ordnancesurvey.co.uk/business-and-government/products/terrain-50.html>
* SNH LCA Landscape Character Assessment: <https://gateway.snh.gov.uk/natural-spaces/>
* SNH Wild land: <https://gateway.snh.gov.uk/natural-spaces/>
* JHI LCA Land capability for agriculture: <http://www.hutton.ac.uk/learning/natural-resource-datasets>
* JHI LCA Land capability for forestry: <http://www.hutton.ac.uk/learning/natural-resource-datasets>
* Agricultural census **rough grazing - to do**: RESAS

```{r data load}
restrictions = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/spatial-processed/parish_restrictions.csv") %>% 
   mutate_all(funs(replace(., is.na(.), 0)))

parishes = parishes %>% 
   left_join(restrictions, by=c("PARCode"="PARCode", "PARName"="PARName")) %>% 
   mutate_all(funs(replace(., is.na(.), 0)))
```

Preparation of these datasets extracted data at an agricultural parish level.
Exact specification for this process is detailed in:

* `grass_read.R` which reads files into GRASS GIS
* `grass_analysis.R` clips polygon data to agricultural parishes and measures subsequent polygon sizes. Terrain values (elevation and slope) are also extracted from raster data.
* `read_hill_class.R` combines data from the GRASS analysis and aggregates to parish levels. Crucially, at a parish level proportion of land is reported as being less viable, i.e. higher proportions mean a parish is more likely to be hill farming.

### Urban rural

Agricultural parishes cover the entire land mass of Scotland, so some are predominantly urban areas.
Below is a map showing the proportion of each parish which is classified as rural in the two fold urban-rural classification.

```{r urban-rural_map}
ggplot(parishes, aes(long, lat, fill=rural_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Rural\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

Urban-rural classification does not make a distiction between upland and lowland areas, but a remoteness index of how long it takes to travel (by driving) to the nearest town. Hence, it does not represent the ease or challenge of farming in a given parish. It does, however give an indication of proximity to market.


### Terrain

A digital elevation model was used to get terrain data for each parish.
These were for elevation and slope and values extracted were minimum, mean, median and maximum.

#### Elevation

How do different elevation measures relate to each other?

```{r elevation_pairs, fig.height=8, fig.width=8}
restrictions %>% 
   select(elev__minimum, elev__average, elev__median, elev__maximum) %>% 
   pairs()
```

Mean (average), median and maximum elevation appear to be closely related, but there is variability between each of these and minimum elevation. This is likely due to in-cell elevation variation, e.g. some cells will have a range from 0 to 1000 m, but others a small range.

Median parish elevation has been chosen as a single measure of parish elevation.

```{r elevation}
ggplot(parishes, aes(long, lat, fill=elev__median, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Elevation\n median (m)") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```


#### Slope

How do different slope measures relate to each other?

```{r slope_pairs, fig.height=8, fig.width=8}
restrictions %>% 
   select(slope__minimum, slope__average, slope__median, slope__maximum) %>% 
   pairs()
```

As with elevation, the average (mean and median) slope measures correlate well. There is greater variability when compared to maximum slopes, but the largest variation is when comparing these to minimum slopes.

A median slope has been used as a single parish slope indicator.

```{r slope, fig.height=10}
ggplot(parishes, aes(long, lat, fill=slope__median, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Slope median\n(degrees)") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```


### Common grazing

```{r common_grazing}
ggplot(parishes, aes(long, lat, fill=grazing_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_distiller(palette="Greens", direction=1) +
   labs(fill="Common\ngrazing\nproportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```


### SNH LCA Landscape Character Assessment

The following have been taken from the SNH landscape character assessment level 3 as hill farming:

```{r SNH_lca_character}
x = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/spatial-processed/LCA_SCOTLAND_parishes.csv") %>% 
   select(a_LEVEL_3) %>% 
   distinct()

y = c("Flat or Rolling, Smooth or Sweeping, Extensive, High Moorlands of the Highlands and Islands",
                           "Inland Loch",
                           "Highland Straths",
                           "Moorland Transitional Landscapes of the Highlands and Islands",
                           "High, Massive, Rolling, Rounded Mountains of the Highlands and Islands",
                           "High Massive Mountain Plateau of the Cairngorms",
                           "Smooth Upland Moorland Hills",
                           "Highland Foothills",
                           "Upland Igneous and Volcanic Hills The Ochil, Sidlaw, Cleish and Lomond Hills",
                           "High, Massive, Rugged, Steep-Sided Mountains of the Highlands and Islands",
                           "Sea Lochs of the Highlands and Islands",
                           "Highland and Island Rocky Coastal Landscapes",
                           "Peatland Landscapes  of the Highlands and Islands",
                           "Rocky Moorlands of the Highlands and Islands",
                           "Rugged, Craggy Upland Hills and Moorlands of the Highlands, including the Trossachs",
                           "Low Coastal Hills of the Highlands and Islands",
                           "Coastal Hills Headlands Plateaux and Moorlands",
                           "Lowland Hills",
                           "Foothills and Pronounced Hills",
                           "Upland Hills, The Southern Uplands and Cheviots",
                           "High Plateau Moorlands",
                           "Rugged Granite Uplands",
                           "Rocky Volcanic Islands",
                           "Rugged Moorland Hills",
                           "Upland Fringe Moorland",
                           "Upland Hills, The Lammemuir, Pentland and Moorfoot Hills",
                           "Rocky Coasts Cliffs and Braes of the Lowlands",
                           "Knock or Rock and Lochan of the Islands",
                           "Highland Cnocan")

data.frame(hill_farming=y) %>% 
   kable()

data.frame(not_hill_farming=x$a_LEVEL_3[!x$a_LEVEL_3 %in% y]) %>%
   kable()
```


```{r SNH_lca}
parishes %>% 
   ggplot(aes(long, lat, fill=landscape_class_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Upland\nLandscape\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

### SNH Wild land

```{r SNH_wild_land}
parishes %>% 
   ggplot(aes(long, lat, fill=wildland_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Wild land\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

#### Protected areas

```{r SNH_NNR}
parishes %>% 
   ggplot(aes(long, lat, fill=NNR_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="NNR\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

```{r SNH_peat_areas}
x = read_csv("~/Cloud/Michael/SRUC/hill_farms/data/spatial-processed/PEAT_SCOTLAND_parishes.csv") %>% 
   select(a_PRIMARY_LA) %>% 
   distinct()

y=c("Blanket bog/peat. veg.", "Water", "Montane veg.", "Cliffs", "Dubh lochans", "Undiff. heather moor", "Other peat", "Wet heather moor", "Dry heather moor", "Quarries", "Wetlands", "Dune lands", "Bings (area)", "Smooth grass/rushes", "Undiff. Nardus/Molinia", "Snow cover", "Industrial peat", "Ski tows", "Rhododendron")

data.frame(peat_areas=y) %>% 
   kable()

data.frame(not_peat_areas=x$a_PRIMARY_LA[!x$a_PRIMARY_LA %in% y]) %>%
   kable()
```

```{r SNH_peat}
parishes %>% 
   ggplot(aes(long, lat, fill=peat_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Peat\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

```{r SNH_SPA}
parishes %>% 
   ggplot(aes(long, lat, fill=SPA_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="SPA\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

### JHI LCA Land capability for agriculture

```{r JHI_lca}
parishes %>% 
   ggplot(aes(long, lat, fill=land_cap_ag_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Agriculture\n6 & 7 class\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

### JHI LCA Land capability for forestry

```{r JHI_lcf}
parishes %>% 
   ggplot(aes(long, lat, fill=land_cap_forest_prop, group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_viridis() +
   labs(fill="Forestry\nF6 & F7\nProportion") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```



## Group parishes into similar levels

How related are proportions?

```{r proportion_pairs, fig.height=10, fig.width=10}
restrictions %>% 
   select(elev__median, slope__median, grazing_prop, landscape_class_prop, land_cap_ag_prop, land_cap_forest_prop, wildland_prop, rural_prop, peat_prop, NNR_prop) %>% 
   pairs()
```

### Build k-means model

```{r build}
x = restrictions %>% 
   select(elev__median, slope__median, grazing_prop, landscape_class_prop, land_cap_ag_prop, land_cap_forest_prop, wildland_prop, rural_prop, NNR_prop, peat_prop)

# Standardise values
x = scale(x)

# Determine number of clusters
wss = (nrow(x) -1) * sum(apply(x, 2, var))
for (i in 2:10){
   wss[i] = sum(kmeans(x, centers=i)$withinss)
}

plot(1:10, wss, type="b", main="Required number of clusters", xlab="Number of Clusters", ylab="Within groups sum of squares")
```

```{r run}
set.seed(224)

fit2 = kmeans(x, 2) # 2 cluster solution
fit6 = kmeans(x, 6) # 6 cluster solution

# append cluster assignment
restrictions = data.frame(restrictions, cluster2=fit2$cluster, cluster6=fit6$cluster)
```

```{r map}
parishes = parishes %>% 
   left_join(select(restrictions, PARCode, cluster2, cluster4))

parishes %>% 
   ggplot(aes(long, lat, fill=as.character(cluster2), group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_brewer(palette="Dark2") +
   labs(fill="Hill or not") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())

parishes %>% 
   ggplot(aes(long, lat, fill=as.character(cluster6), group=group)) +
   geom_polygon(size=0.1,
                colour="grey30") +
   coord_equal() +
   scale_fill_brewer(palette="Dark2") +
   labs(fill="Hill or not") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```


## Rank/score each parish in terms of hilliness

Create a score, which can then be ranked.

```{r score}
score = restrictions %>% 
   select(-PARName,
          -elev__minimum, -elev__average, -elev__maximum,
          -slope__minimum, -slope__average, -slope__maximum,
          -SPA_prop) %>% 
   mutate(elev__median=elev__median/max(elev__median),
          slope__median=slope__median/max(slope__median)) %>% 
   gather(variable, value, -PARCode) %>% 
   group_by(PARCode) %>% 
   summarise(score=sum(value))

parishes = parishes %>% 
   left_join(score)

parishes %>% 
   ggplot(aes(long, lat, fill=score, group=group)) +
   geom_polygon() +
   coord_equal() +
   scale_fill_viridis(option="magma") +
   labs(fill="Hill\nscore") +
   theme_minimal() +
   theme(axis.text=element_blank(),
         axis.title=element_blank(),
         line=element_blank())
```

